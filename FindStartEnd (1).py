#!/usr/bin/env python
# coding: utf-8

# In[1]:


import sys
import numpy as np
import pandas as pd
from pandas import Series
import matplotlib.pyplot as plt


# In[3]:


ts = pd.read_csv("ts.csv", header=0, index_col=0, parse_dates=True, squeeze=True)
ts.plot()


# In[28]:


def difference(dataset, interval=1):
    diff = list()
    for i in range(interval, len(dataset)):
        value = dataset[i] - dataset[i - interval]
        diff.append(value)
    return Series(diff)

diff = difference(ts.values)


diff.plot(x = 'index', y = 0, kind = 'line')
plt.xlabel('Frames')
plt.ylabel('Differences')
plt.show()

diff.plot(y = 0, kind = 'hist', bins = 100)
plt.xlabel('Differences')
plt.ylabel('Frequency')
plt.show()

diff2.plot(x = 'index', y = 0, kind = 'line')
plt.xlabel('Frames')
plt.ylabel('Second Differences')
plt.show()


# In essence:
# 1. Find upper and lower bound of differences, subject to 20 standard deviations away from mean
# 2. Find frames where differences are greater than upper bound and lower than lower bound
# 3. Find longest 'continuous' out of bounds period
# 4. return start and end index

# In[32]:


#inputs
n_std = 20
window = 5


mean = np.mean(diff)
std = np.std(diff)
ubound = mean + n_std*std/(np.sqrt(len(diff)))
lbound = mean - n_std*std/(np.sqrt(len(diff)))


print(f'upper bound is {ubound}')
print(f'lower bound is {lbound}')


#Find points > upper bound or < lower bound
#count number of points > or <
count = 0
index = []
for i in range(0, len(diff)-1):
    if diff[i] > ubound or diff[i] < lbound:
        count += 1
        index.append(i)
        
print(f'{count} number of frames out of bounds')
print(index)


start_arr = [0]
end_arr = []

#for each frame, check if next frame is in look ahead window (4 days ahead)
#if not, append current index (end) to an end list
# and append next index (start) to start list
for j in range(0, len(index)-1): 
    window_list = [p for p in range(index[j], index[j]+window)]
    if index[j+1] not in window_list:
        start_arr.append(j+1)
        end_arr.append(j)
        

#remove end element so len(start_arr) == len(end_array)
start_arr = start_arr[0:-1]

#subtract end and start lists to find lengths of segments
lengths = np.array(end_arr)-np.array(start_arr)

#return start and end frames with longest period of high volatility
best_start = index[start_arr[np.argmax(lengths)]]
best_end = index[end_arr[np.argmax(lengths)]]
   
print(f'start list : {start_arr}')
print(f'end list : {end_arr}')
print(f'lengths list :{lengths}')
print(f'best estimated start frame is {best_start}')
print(f'best estimated end frame is {best_end}')


# In[24]:



#visual plot

diff.plot(x = 'index', y = 0, kind = 'line', label = 'difference')
plt.axhline(y = ubound, color ="green", linestyle ="--", label = 'upper and lower bound')
plt.axhline(y = lbound, color ="green", linestyle ="--")
plt.axvline(x = best_start, color ="red", linestyle ="solid", label = 'estimated start and end')
plt.axvline(x = best_end, color ="red", linestyle ="solid")
plt.xlabel('Frames')
plt.ylabel('Differences')
plt.legend()
plt.show()


# In[ ]:





# In[ ]:





# In[33]:


#data


# In[34]:


#ts = {"1":0.0028845175,"2":0.0028752018,"3":0.0027866823,"4":0.0027029461,"5":0.0025577342,"6":0.0023738419,"7":0.002282417,"8":0.0021902586,"9":0.0026794945,"10":0.0027843874,"11":0.0029190955,"12":0.002782563,"13":0.0025908357,"14":0.0025013017,"15":0.0022499495,"16":0.0023141446,"17":0.0019800507,"18":0.0021697316,"19":0.0024577275,"20":0.0048768442,"21":0.0067088652,"22":0.008865599,"23":0.0093519601,"24":0.0101262241,"25":0.0104621711,"26":0.012587104,"27":0.0154018401,"28":0.0189764183,"29":0.0219241893,"30":0.0257124218,"31":0.0297400043,"32":0.0332990031,"33":0.0354811054,"34":0.0363950039,"35":0.036286777,"36":0.0354866428,"37":0.0348069313,"38":0.0283702081,"39":0.0267982065,"40":0.0245460237,"41":0.0281535302,"42":0.0266027659,"43":0.0257306304,"44":0.0244359046,"45":0.0229846286,"46":0.021480424,"47":0.0210508572,"48":0.0208865826,"49":0.0208963767,"50":0.0198772016,"51":0.0190223419,"52":0.0166200654,"53":0.0148724303,"54":0.0132892026,"55":0.0129446011,"56":0.0127004195,"57":0.0123675209,"58":0.0121716288,"59":0.0121925035,"60":0.0120501009,"61":0.0121529289,"62":0.012085665,"63":0.0122616365,"64":0.0122390582,"65":0.0120644569,"66":0.011821261,"67":0.0119752876,"68":0.0120473314,"69":0.0123415198,"70":0.0122109196,"71":0.0121748196,"72":0.0120169086,"73":0.0118961664,"74":0.0115007215,"75":0.0112284929,"76":0.010957644,"77":0.0111781274,"78":0.011467137,"79":0.0118942913,"80":0.0119493331,"81":0.0124466159,"82":0.0125863471,"83":0.013004265,"84":0.012977437,"85":0.013519154,"86":0.0146151736,"87":0.0162595128,"88":0.0203697582,"89":0.0287329417,"90":0.0434624661,"91":0.057126489,"92":0.0672236192,"93":0.071553424,"94":0.0747144144,"95":0.0772089543,"96":0.0785323806,"97":0.0790779544,"98":0.0790552719,"99":0.0790682697,"100":0.0804259163,"101":0.080424435,"102":0.0808342383,"103":0.078528479,"104":0.077290577,"105":0.0742571586,"106":0.072111949,"107":0.0691269509,"108":0.0673486507,"109":0.0659260216,"110":0.0651057273,"111":0.0647859076,"112":0.0648068757,"113":0.0654637705,"114":0.066633248,"115":0.0684525704,"116":0.0705500804,"117":0.0701791351,"118":0.069655362,"119":0.0686223355,"120":0.0683987565,"121":0.0673899033,"122":0.0666050674,"123":0.0666632382,"124":0.0683420057,"125":0.0698869447,"126":0.0707697929,"127":0.0700963529,"128":0.0691940596,"129":0.0695752342,"130":0.070205088,"131":0.0710573734,"132":0.0712496474,"133":0.0714214466,"134":0.0703880665,"135":0.0671371566,"136":0.0540520143,"137":0.0482744449,"138":0.0284659619,"139":0.0182271375,"140":0.0033027856,"141":0.0063611965,"142":0.0072155641,"143":0.0092264549,"144":0.0173298489,"145":0.0341042785,"146":0.0521689205,"147":0.063873973,"148":0.0690295942,"149":0.0698771633,"150":0.0673641435,"151":0.0615378247,"152":0.0567005119,"153":0.0463907118,"154":0.0352612401,"155":0.0179394481,"156":0.0075978873,"157":0.0027419285,"158":0.0064794099,"159":0.0217207157,"160":0.040080166,"161":0.0579895099,"162":0.0670209819,"163":0.0719793722,"164":0.0728767472,"165":0.063013787,"166":0.0522455222,"167":0.0297546978,"168":0.0150751678,"169":0.0021135203,"170":0.0019607355,"171":0.0126070461,"172":0.0148054851,"173":0.0408258026,"174":0.0479488469,"175":0.0676789293,"176":0.065454181,"177":0.0705934362,"178":0.0705532921,"179":0.0551155286,"180":0.0373912951,"181":0.0146064501,"182":0.0067819186,"183":0.0014790832,"184":0.0036541931,"185":0.0219070573,"186":0.0401953161,"187":0.050051359,"188":0.0601250534,"189":0.0730653748,"190":0.0770324433,"191":0.0562042856,"192":0.0388978623,"193":0.0183519695,"194":0.0179121496,"195":0.0158021807,"196":0.0163300793,"197":0.0094588062,"198":0.0143358258,"199":0.0191098867,"200":0.0326774303,"201":0.0421939393,"202":0.0593720161,"203":0.0694911135,"204":0.0750525149,"205":0.0736641595,"206":0.053438705,"207":0.0396903507,"208":0.0191313646,"209":0.015466014,"210":0.0044260242,"211":0.0075677196,"212":0.0266145162,"213":0.0448426156,"214":0.0598230183,"215":0.0588124881,"216":0.042775965,"217":0.0242675545,"218":0.0054981167,"219":0.0032219684,"220":0.0030055097,"221":0.0045232585,"222":0.0185190787,"223":0.0303692648,"224":0.0470651624,"225":0.0524035409,"226":0.0603545014,"227":0.062368558,"228":0.0565570183,"229":0.0407723114,"230":0.0207809057,"231":0.006815274,"232":0.0026684048,"233":0.0034700743,"234":0.0062919092,"235":0.0172873724,"236":0.0332841112,"237":0.0492450318,"238":0.0592199598,"239":0.0649345307,"240":0.0661772544,"241":0.0674755331,"242":0.0518381812,"243":0.0422835917,"244":0.0198128595,"245":0.014176078,"246":0.0022884756,"247":0.0128107376,"248":0.0164293778,"249":0.025798372,"250":0.0371732694,"251":0.0521371665,"252":0.0632315226,"253":0.0533210459,"254":0.0371855612,"255":0.0254620534,"256":0.0162509225,"257":0.0139835387,"258":0.0039753707,"259":0.0037664187,"260":0.00327296,"261":0.002717699,"262":0.0025914409,"263":0.0062781717,"264":0.014927421,"265":0.023709937,"266":0.0276074947,"267":0.0257036674,"268":0.0235844915,"269":0.0233265976,"270":0.0254320302,"271":0.027883117,"272":0.030201464,"273":0.0312467707,"274":0.0317093753,"275":0.0318457426,"276":0.0316214588,"277":0.0306059956,"278":0.0295081256,"279":0.0277607804,"280":0.02671764,"281":0.0248145123,"282":0.0243873608,"283":0.0237746757,"284":0.0166618403,"285":0.0137325834,"286":0.029171022,"287":0.0329511813,"288":0.0350192244,"289":0.037422638,"290":0.0232542869,"291":0.0248084001,"292":0.0080494253,"293":0.0066140049,"294":0.0062863086,"295":0.0084351463,"296":0.0102380496,"297":0.0128573906,"298":0.0136307829,"299":0.0137726692,"300":0.0132209198,"301":0.0119269358,"302":0.0114184737,"303":0.0115491817,"304":0.0118854399,"305":0.0114653234,"306":0.0111995691,"307":0.010719345,"308":0.0111141557,"309":0.0134651206,"310":0.0151143934,"311":0.0166397923,"312":0.0139403993,"313":0.0131710869,"314":0.0116959389,"315":0.0115704666,"316":0.0108634486,"317":0.0105687403,"318":0.0103755799,"319":0.0100479458,"320":0.009597382,"321":0.0093926751,"322":0.0090658132,"323":0.0092131835,"324":0.0091832971,"325":0.0100812545,"326":0.0101913425,"327":0.0119809049,"328":0.0117134807,"329":0.0119142277,"330":0.011493642,"331":0.0108675879,"332":0.0103500856,"333":0.0091222862,"334":0.009757498,"335":0.0106161341,"336":0.0111494094,"337":0.011127309,"338":0.010714989,"339":0.0107236868,"340":0.0108751088,"341":0.0111514028,"342":0.0112842797,"343":0.0112817858,"344":0.0119645716,"345":0.0123053277,"346":0.0121248269,"347":0.0104818153,"348":0.0085958218,"349":0.00855291,"350":0.0095287201,"351":0.0111559076,"352":0.0121483883,"353":0.0125420986,"354":0.0135477003,"355":0.0120869364,"356":0.0110636256,"357":0.0094131412,"358":0.0104118504,"359":0.0103731587,"360":0.0112235337,"361":0.0105629327,"362":0.0105805706,"363":0.010565075,"364":0.0114352812,"365":0.0107208724,"366":0.0103775751,"367":0.0104670099,"368":0.0114145148,"369":0.010940535,"370":0.0103399678,"371":0.0099594755,"372":0.0111961578,"373":0.0110690423,"374":0.011452103,"375":0.0100941322,"376":0.0100736774,"377":0.0114828696,"378":0.0130759806,"379":0.014271339,"380":0.0135325126,"381":0.0129782346,"382":0.0124493718,"383":0.0126423319,"384":0.0124684558,"385":0.0123698046,"386":0.0123418509,"387":0.0136900055,"388":0.0125420447,"389":0.0118916919,"390":0.0098861849,"391":0.0098526336,"392":0.0086265019,"393":0.0100019146,"394":0.010199469,"395":0.0106262879,"396":0.0076750304,"397":0.0062061923,"398":0.0054785474,"399":0.0058752767,"400":0.0065499518,"401":0.0063208608,"402":0.0069263175,"403":0.0053900394,"404":0.0067438733,"405":0.0058695959,"406":0.0069126535,"407":0.0066645349,"408":0.0113251594,"409":0.0176399424,"410":0.0237605967,"411":0.0256175411,"412":0.0267155694,"413":0.0273211252,"414":0.0268272364,"415":0.0260145346,"416":0.0205862698,"417":0.0159359559,"418":0.0114466546,"419":0.0117198638,"420":0.0118622254,"421":0.0118533277,"422":0.0109928987,"423":0.0145584925,"424":0.0155051295,"425":0.0166230835,"426":0.0131450495,"427":0.0168560354,"428":0.0191192744,"429":0.0226778364,"430":0.0225928288,"431":0.0209161453,"432":0.0181517078,"433":0.0154598471,"434":0.0154522328,"435":0.0170479014,"436":0.0184918161,"437":0.0200797887,"438":0.0198998591,"439":0.0198974572,"440":0.0198271793,"441":0.0199309737,"442":0.0200082584,"443":0.0202472243,"444":0.0202888173,"445":0.0203708734,"446":0.0203636075,"447":0.0204170878,"448":0.0204734164,"449":0.0207325426,"450":0.0204474945,"451":0.019656537,"452":0.0186669566,"453":0.0182581776,"454":0.0188880429,"455":0.0195061475,"456":0.0202899889,"457":0.0203615821,"458":0.0205469468,"459":0.0205515107,"460":0.0205580469,"461":0.0204280267,"462":0.0204790625,"463":0.0186820342,"464":0.0188594196,"465":0.0173075665,"466":0.0192825372,"467":0.0193364019,"468":0.0209185947,"469":0.0208789872,"470":0.0208534146,"471":0.0208744214,"472":0.0209852179,"473":0.0209065297,"474":0.0208314271,"475":0.0207149516,"476":0.0207375005,"477":0.0205288413,"478":0.0201977361,"479":0.0203379279,"480":0.0207661587,"481":0.0205363095,"482":0.0196221739,"483":0.0185080119,"484":0.0179511625,"485":0.0180165449,"486":0.0178531842,"487":0.017894533,"488":0.017537581,"489":0.0180953893,"490":0.0186555315,"491":0.0192159081,"492":0.0190848171,"493":0.018775871,"494":0.0186426846,"495":0.0186725182,"496":0.0188861356,"497":0.0191151808,"498":0.0195954889,"499":0.0200767386,"500":0.0203682746,"501":0.0208836117,"502":0.0213606102,"503":0.0213673115,"504":0.0207201773,"505":0.0194377793,"506":0.0182062435,"507":0.0172689422,"508":0.0169957675,"509":0.0188745639,"510":0.0175891937,"511":0.0160764774,"512":0.0126141305,"513":0.0123378689,"514":0.0158627158,"515":0.0195973475,"516":0.0232392006,"517":0.0232505123,"518":0.0228394132,"519":0.0223741489,"520":0.0218639221,"521":0.0220661153,"522":0.0221362719,"523":0.0216360886,"524":0.0215123576,"525":0.0217612933,"526":0.0226408686,"527":0.0228389315,"528":0.0218351978,"529":0.0206486353,"530":0.019981653,"531":0.0196198489,"532":0.0200926067,"533":0.0197455988,"534":0.0201839032,"535":0.0201073111,"536":0.0203342618,"537":0.0198940949,"538":0.0194484138,"539":0.0183976177,"540":0.0180552701,"541":0.0180771145,"542":0.0189333707,"543":0.0198295481,"544":0.0202147952,"545":0.0197118276,"546":0.0191109068,"547":0.0185214566,"548":0.0185886034,"549":0.0184215097,"550":0.0182517977,"551":0.0178694766,"552":0.0178820011,"553":0.0178991129,"554":0.0180934992,"555":0.0173243641,"556":0.0164326948,"557":0.015708892,"558":0.0163983784,"559":0.0165373424,"560":0.0165045094,"561":0.0159637121,"562":0.0157982599,"563":0.0156634665,"564":0.0153859478,"565":0.0155406347,"566":0.0158628404,"567":0.0161553036,"568":0.0163235394,"569":0.0161836768,"570":0.01567556,"571":0.015355238,"572":0.015185355,"573":0.015524498,"574":0.0165388202,"575":0.0175706809,"576":0.0184879342,"577":0.0185071203,"578":0.0187058969,"579":0.0192254663,"580":0.0195933194,"581":0.0205073779,"582":0.0199965613,"583":0.0196248447,"584":0.0190368162,"585":0.0198628271,"586":0.02050704,"587":0.0209768324,"588":0.0211372284,"589":0.0216263637,"590":0.0217586701,"591":0.0218341324,"592":0.0218307701,"593":0.0219582628,"594":0.0221402491,"595":0.0223752086,"596":0.0225380249,"597":0.0227533051,"598":0.0228544342,"599":0.0217604339,"600":0.020801901,"601":0.0198492615,"602":0.0198423443,"603":0.0194654126,"604":0.0192344559,"605":0.0193879107,"606":0.0194046726,"607":0.0192823474,"608":0.0189446644,"609":0.0177344895,"610":0.0175573136,"611":0.0174345135,"612":0.017865701,"613":0.0174315981,"614":0.016992686,"615":0.0171512034,"616":0.017369891,"617":0.0174184259,"618":0.0176393978,"619":0.0175076147,"620":0.0177209464,"621":0.0177008632,"622":0.0178249394,"623":0.0171387114,"624":0.0159519496,"625":0.0148791616,"626":0.0144343264,"627":0.0142984526,"628":0.0141871996,"629":0.0140762822,"630":0.014668877,"631":0.0152576067,"632":0.0163991208,"633":0.0180025485,"634":0.0195237936,"635":0.0202865082,"636":0.0201847118,"637":0.020035033,"638":0.0193604045,"639":0.0181300065,"640":0.0174651367,"641":0.0176583553,"642":0.0182925501,"643":0.0184439731,"644":0.0182231499,"645":0.0182854173,"646":0.0180724028,"647":0.0175444435,"648":0.0175257739,"649":0.0171440077,"650":0.0167981438,"651":0.0157553051,"652":0.0161870318,"653":0.0171159795,"654":0.018042938,"655":0.0180182742,"656":0.0181969323,"657":0.0185688698,"658":0.019056292,"659":0.0195147942,"660":0.0197991291,"661":0.0198481462,"662":0.0195745038,"663":0.0191512798,"664":0.0187290264,"665":0.0184516551,"666":0.0183065183,"667":0.0182995024,"668":0.0182892124,"669":0.0182804228,"670":0.0185366789,"671":0.0186621069,"672":0.0187947918,"673":0.0185878078,"674":0.0185133074,"675":0.018434959,"676":0.0184118271,"677":0.0185466447,"678":0.0187356431,"679":0.019127314,"680":0.0191480795,"681":0.0191685403,"682":0.0202559665,"683":0.0184044293,"684":0.0171192022,"685":0.0160910641,"686":0.0195337356,"687":0.0228372091,"688":0.0238670486,"689":0.021848861,"690":0.0194522082,"691":0.0195080422}

